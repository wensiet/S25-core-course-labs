# Secrets

## Creating secret

I prepared special file called `secret.json` it has some mock data for user.

To create this secret in k8s, we need to enter such command:
```bash
➜  k8s git:(lab-11) ✗ k create secret generic my-secret --from-file=secret.json
secret/my-secret created
```

## Get secrets

After creation we can list secrets:
```bash
➜  k8s git:(lab-11) ✗ k get secrets my-secret
NAME        TYPE     DATA   AGE
my-secret   Opaque   1      6s
```

To read and decode it we will use those commands:
```bash
➜  k8s git:(lab-11) ✗ k get secrets my-secret -o jsonpath='{.data}'
{"secret.json":"ewogICJ1c2VybmFtZSI6ICJoZWxsbyIsCiAgInBhc3N3b3JkIjogIndvcmxkIgp9Cg=="}%
➜  k8s git:(lab-11) ✗ echo "ewogICJ1c2VybmFtZSI6ICJoZWxsbyIsCiAgInBhc3N3b3JkIjogIndvcmxkIgp9Cg==" | base64 -d
{
  "username": "hello",
  "password": "world"
}
```

# Secrets in Helm

Following guide we create secret, then we install the chart:
```bash
➜  k8s git:(lab-11) ✗ helm secrets install py-app py-app -f secrets.yaml
[helm-secrets] Decrypt: secrets.yaml

NAME: py-app
LAST DEPLOYED: Sun Mar  2 19:28:20 2025
NAMESPACE: default
STATUS: deployed
REVISION: 1
NOTES:
1. Get the application URL by running these commands:
  export POD_NAME=$(kubectl get pods --namespace default -l "app.kubernetes.io/name=py-app,app.kubernetes.io/instance=py-app" -o jsonpath="{.items[0].metadata.name}")
  export CONTAINER_PORT=$(kubectl get pod --namespace default $POD_NAME -o jsonpath="{.spec.containers[0].ports[0].containerPort}")
  echo "Visit http://127.0.0.1:8080 to use your application"
  kubectl --namespace default port-forward $POD_NAME 8080:$CONTAINER_PORT
[helm-secrets] Removed: secrets.yaml.dec
```

After that we can list pods and print envs:
```bash
➜  k8s git:(lab-11) ✗ kubectl get po
NAME                      READY   STATUS    RESTARTS   AGE
py-app-85c9844cb9-zzcmn   1/1     Running   0          7m39s
```

```bash
➜  k8s git:(lab-11) ✗ kubectl exec py-app-85c9844cb9-zzcmn -- printenv | grep MY_SECRET
MY_SECRET=hello-world
```

# Vault

After following vault secret configureation instructions by hashicorp we can 
see that it injects several containers to our deployment:

```bash
➜  k8s git:(lab-11) ✗ k describe pod py-app-65c866894f-dw9f6
Name:             py-app-65c866894f-dw9f6
Namespace:        default
Priority:         0
Service Account:  internal-app
Node:             devops-lab-9-control-plane/172.21.0.2
Start Time:       Sun, 02 Mar 2025 20:15:23 +0300
Labels:           app.kubernetes.io/instance=py-app
                  app.kubernetes.io/managed-by=Helm
                  app.kubernetes.io/name=py-app
                  app.kubernetes.io/version=1.16.0
                  helm.sh/chart=py-app-0.1.0
                  pod-template-hash=65c866894f
Annotations:      vault.hashicorp.com/agent-inject: true
                  vault.hashicorp.com/agent-inject-secret-database-config.txt: internal/data/database/config
                  vault.hashicorp.com/agent-inject-status: injected
                  vault.hashicorp.com/role: internal-app
Status:           Running
IP:               10.244.0.12
IPs:
  IP:           10.244.0.12
Controlled By:  ReplicaSet/py-app-65c866894f
Init Containers:
  vault-agent-init:
    Container ID:  containerd://21aa5be31103712ff038cd53e7b221606cfae1f41591109754096cf4d05d4f9c
    Image:         hashicorp/vault:1.18.1
    Image ID:      docker.io/hashicorp/vault@sha256:3580fa352195aa7e76449cb8fadeef6d2f90a454c38982d30cf094e9013be786
    Port:          <none>
    Host Port:     <none>
    Command:
      /bin/sh
      -ec
    Args:
      echo ${VAULT_CONFIG?} | base64 -d > /home/vault/config.json && vault agent -config=/home/vault/config.json
    State:          Terminated
      Reason:       Completed
      Exit Code:    0
      Started:      Sun, 02 Mar 2025 20:15:23 +0300
      Finished:     Sun, 02 Mar 2025 20:15:24 +0300
    Ready:          True
    Restart Count:  0
    Limits:
      cpu:     500m
      memory:  128Mi
    Requests:
      cpu:     250m
      memory:  64Mi
    Environment:
      NAMESPACE:         default (v1:metadata.namespace)
      HOST_IP:            (v1:status.hostIP)
      POD_IP:             (v1:status.podIP)
      VAULT_LOG_LEVEL:   info
      VAULT_LOG_FORMAT:  standard
      VAULT_CONFIG:      eyJhdXRvX2F1dGgiOnsibWV0aG9kIjp7InR5cGUiOiJrdWJlcm5ldGVzIiwibW91bnRfcGF0aCI6ImF1dGgva3ViZXJuZXRlcyIsImNvbmZpZyI6eyJyb2xlIjoiaW50ZXJuYWwtYXBwIiwidG9rZW5fcGF0aCI6Ii92YXIvcnVuL3NlY3JldHMva3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC90b2tlbiJ9fSwic2luayI6W3sidHlwZSI6ImZpbGUiLCJjb25maWciOnsicGF0aCI6Ii9ob21lL3ZhdWx0Ly52YXVsdC10b2tlbiJ9fV19LCJleGl0X2FmdGVyX2F1dGgiOnRydWUsInBpZF9maWxlIjoiL2hvbWUvdmF1bHQvLnBpZCIsInZhdWx0Ijp7ImFkZHJlc3MiOiJodHRwOi8vdmF1bHQuZGVmYXVsdC5zdmM6ODIwMCJ9LCJ0ZW1wbGF0ZSI6W3siZGVzdGluYXRpb24iOiIvdmF1bHQvc2VjcmV0cy9kYXRhYmFzZS1jb25maWcudHh0IiwiY29udGVudHMiOiJ7eyB3aXRoIHNlY3JldCBcImludGVybmFsL2RhdGEvZGF0YWJhc2UvY29uZmlnXCIgfX17eyByYW5nZSAkaywgJHYgOj0gLkRhdGEgfX17eyAkayB9fToge3sgJHYgfX1cbnt7IGVuZCB9fXt7IGVuZCB9fSIsImxlZnRfZGVsaW1pdGVyIjoie3siLCJyaWdodF9kZWxpbWl0ZXIiOiJ9fSJ9XSwidGVtcGxhdGVfY29uZmlnIjp7ImV4aXRfb25fcmV0cnlfZmFpbHVyZSI6dHJ1ZX19
    Mounts:
      /home/vault from home-init (rw)
      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-5d96p (ro)
      /vault/secrets from vault-secrets (rw)
Containers:
  py-app:
    Container ID:   containerd://017e316dfaba2ed99b3ac8a6116f930ba8a5331abe5d7553b3a2b1ae53692cf2
    Image:          wensiet/devops-py-app:release
    Image ID:       docker.io/wensiet/devops-py-app@sha256:2604a94ca88673481276c8173a6325983ef6498350a0c25b557a2098fe551f10
    Port:           8000/TCP
    Host Port:      0/TCP
    State:          Running
      Started:      Sun, 02 Mar 2025 20:15:24 +0300
    Ready:          True
    Restart Count:  0
    Limits:
      cpu:     100m
      memory:  128Mi
    Requests:
      cpu:     100m
      memory:  128Mi
    Environment:
      MY_SECRET:  <set to the key 'password' in secret 'credentials'>  Optional: false
    Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-5d96p (ro)
      /vault/secrets from vault-secrets (rw)
  vault-agent:
    Container ID:  containerd://cfd32cf76e0822e68347223c35072c0d255c3d30c47250d82d08ef2ec962e659
    Image:         hashicorp/vault:1.18.1
    Image ID:      docker.io/hashicorp/vault@sha256:3580fa352195aa7e76449cb8fadeef6d2f90a454c38982d30cf094e9013be786
    Port:          <none>
    Host Port:     <none>
    Command:
      /bin/sh
      -ec
    Args:
      echo ${VAULT_CONFIG?} | base64 -d > /home/vault/config.json && vault agent -config=/home/vault/config.json
    State:          Running
      Started:      Sun, 02 Mar 2025 20:15:25 +0300
    Ready:          True
    Restart Count:  0
    Limits:
      cpu:     500m
      memory:  128Mi
    Requests:
      cpu:     250m
      memory:  64Mi
    Environment:
      NAMESPACE:         default (v1:metadata.namespace)
      HOST_IP:            (v1:status.hostIP)
      POD_IP:             (v1:status.podIP)
      VAULT_LOG_LEVEL:   info
      VAULT_LOG_FORMAT:  standard
      VAULT_CONFIG:      eyJhdXRvX2F1dGgiOnsibWV0aG9kIjp7InR5cGUiOiJrdWJlcm5ldGVzIiwibW91bnRfcGF0aCI6ImF1dGgva3ViZXJuZXRlcyIsImNvbmZpZyI6eyJyb2xlIjoiaW50ZXJuYWwtYXBwIiwidG9rZW5fcGF0aCI6Ii92YXIvcnVuL3NlY3JldHMva3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC90b2tlbiJ9fSwic2luayI6W3sidHlwZSI6ImZpbGUiLCJjb25maWciOnsicGF0aCI6Ii9ob21lL3ZhdWx0Ly52YXVsdC10b2tlbiJ9fV19LCJleGl0X2FmdGVyX2F1dGgiOmZhbHNlLCJwaWRfZmlsZSI6Ii9ob21lL3ZhdWx0Ly5waWQiLCJ2YXVsdCI6eyJhZGRyZXNzIjoiaHR0cDovL3ZhdWx0LmRlZmF1bHQuc3ZjOjgyMDAifSwidGVtcGxhdGUiOlt7ImRlc3RpbmF0aW9uIjoiL3ZhdWx0L3NlY3JldHMvZGF0YWJhc2UtY29uZmlnLnR4dCIsImNvbnRlbnRzIjoie3sgd2l0aCBzZWNyZXQgXCJpbnRlcm5hbC9kYXRhL2RhdGFiYXNlL2NvbmZpZ1wiIH19e3sgcmFuZ2UgJGssICR2IDo9IC5EYXRhIH19e3sgJGsgfX06IHt7ICR2IH19XG57eyBlbmQgfX17eyBlbmQgfX0iLCJsZWZ0X2RlbGltaXRlciI6Int7IiwicmlnaHRfZGVsaW1pdGVyIjoifX0ifV0sInRlbXBsYXRlX2NvbmZpZyI6eyJleGl0X29uX3JldHJ5X2ZhaWx1cmUiOnRydWV9fQ==
    Mounts:
      /home/vault from home-sidecar (rw)
      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-5d96p (ro)
      /vault/secrets from vault-secrets (rw)
Conditions:
  Type                        Status
  PodReadyToStartContainers   True
  Initialized                 True
  Ready                       True
  ContainersReady             True
  PodScheduled                True
Volumes:
  kube-api-access-5d96p:
    Type:                    Projected (a volume that contains injected data from multiple sources)
    TokenExpirationSeconds:  3607
    ConfigMapName:           kube-root-ca.crt
    ConfigMapOptional:       <nil>
    DownwardAPI:             true
  home-init:
    Type:       EmptyDir (a temporary directory that shares a pod's lifetime)
    Medium:     Memory
    SizeLimit:  <unset>
  home-sidecar:
    Type:       EmptyDir (a temporary directory that shares a pod's lifetime)
    Medium:     Memory
    SizeLimit:  <unset>
  vault-secrets:
    Type:        EmptyDir (a temporary directory that shares a pod's lifetime)
    Medium:      Memory
    SizeLimit:   <unset>
QoS Class:       Burstable
Node-Selectors:  <none>
Tolerations:     node.kubernetes.io/not-ready:NoExecute op=Exists for 300s
                 node.kubernetes.io/unreachable:NoExecute op=Exists for 300s
Events:
  Type    Reason     Age    From               Message
  ----    ------     ----   ----               -------
  Normal  Scheduled  4m38s  default-scheduler  Successfully assigned default/py-app-65c866894f-dw9f6 to devops-lab-9-control-plane
  Normal  Pulled     4m38s  kubelet            Container image "hashicorp/vault:1.18.1" already present on machine
  Normal  Created    4m38s  kubelet            Created container vault-agent-init
  Normal  Started    4m38s  kubelet            Started container vault-agent-init
  Normal  Pulled     4m37s  kubelet            Container image "wensiet/devops-py-app:release" already present on machine
  Normal  Created    4m37s  kubelet            Created container py-app
  Normal  Started    4m37s  kubelet            Started container py-app
  Normal  Pulled     4m37s  kubelet            Container image "hashicorp/vault:1.18.1" already present on machine
  Normal  Created    4m37s  kubelet            Created container vault-agent
  Normal  Started    4m36s  kubelet            Started container vault-agent
```

Basically, vault mounts secrets engine to our main container, so we can reach 
secrets from our app (statically or dynamically).

To get secret value we follow the lab instructions (secret format is golang map by default):
```bash
➜  k8s git:(lab-11) ✗ k exec -it py-app-65c866894f-dw9f6 -- /bin/sh
Defaulted container "py-app" out of: py-app, vault-agent, vault-agent-init (init)
$ cat /vault/secrets/database-config.txt
data: map[password:db-secret-password username:db-readonly-username]
metadata: map[created_time:2025-03-02T17:10:28.69781291Z custom_metadata:<nil> deletion_time: destroyed:false version:1]
```

# Resources

Requests and limits for containers were already configured. 
You can see it in pod description above.

